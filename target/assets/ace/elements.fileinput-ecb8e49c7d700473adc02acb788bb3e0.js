!function($,undefined){var multiplible="multiple"in document.createElement("INPUT"),hasFileList="FileList"in window,hasFileReader="FileReader"in window,hasFile="File"in window,Ace_File_Input=function(element,settings){var self=this;this.settings=$.extend({},$.fn.ace_file_input.defaults,settings),this.$element=$(element),this.element=element,this.disabled=!1,this.can_reset=!0,this.$element.off("change.ace_inner_call").on("change.ace_inner_call",function(e,ace_inner_call){return self.disabled||ace_inner_call===!0?void 0:handle_on_change.call(self)});var parent_label=this.$element.closest("label").css({display:"block"}),tagName=0==parent_label.length?"label":"span";this.$element.wrap("<"+tagName+' class="ace-file-input" />'),this.apply_settings(),this.reset_input_field()};Ace_File_Input.error={FILE_LOAD_FAILED:1,IMAGE_LOAD_FAILED:2,THUMBNAIL_FAILED:3},Ace_File_Input.prototype.apply_settings=function(){var self=this;this.multi=this.$element.attr("multiple")&&multiplible,this.well_style="well"==this.settings.style,this.well_style?this.$element.parent().addClass("ace-file-multiple"):this.$element.parent().removeClass("ace-file-multiple"),this.$element.parent().find(":not(input[type=file])").remove(),this.$element.after('<span class="ace-file-container" data-title="'+this.settings.btn_choose+'"><span class="ace-file-name" data-title="'+this.settings.no_file+'">'+(this.settings.no_icon?'<i class="'+ace.vars.icon+this.settings.no_icon+'"></i>':"")+"</span></span>"),this.$label=this.$element.next(),this.$container=this.$element.closest(".ace-file-input");var remove_btn=!!this.settings.icon_remove;if(remove_btn){var btn=$('<a class="remove" href="#"><i class="'+ace.vars.icon+this.settings.icon_remove+'"></i></a>').appendTo(this.$element.parent());btn.on(ace.click_event,function(e){if(e.preventDefault(),!self.can_reset)return!1;var ret=!0;if(self.settings.before_remove&&(ret=self.settings.before_remove.call(self.element)),!ret)return!1;self.reset_input();return!1})}this.settings.droppable&&hasFileList&&enable_drop_functionality.call(this)},Ace_File_Input.prototype.show_file_list=function($files,inner_call){var files="undefined"==typeof $files?this.$element.data("ace_input_files"):$files;if(files&&0!=files.length){this.well_style&&(this.$label.find(".ace-file-name").remove(),this.settings.btn_change||this.$label.addClass("hide-placeholder")),this.$label.attr("data-title",this.settings.btn_change).addClass("selected");for(var i=0;i<files.length;i++){var filename="",format=!1;if("string"==typeof files[i])filename=files[i];else if(hasFile&&files[i]instanceof File)filename=$.trim(files[i].name);else{if(!(files[i]instanceof Object&&files[i].hasOwnProperty("name")))continue;filename=files[i].name,files[i].hasOwnProperty("type")&&(format=files[i].type),files[i].hasOwnProperty("path")||(files[i].path=files[i].name)}var index=filename.lastIndexOf("\\")+1;0==index&&(index=filename.lastIndexOf("/")+1),filename=filename.substr(index),0==format&&(format=/\.(jpe?g|png|gif|svg|bmp|tiff?)$/i.test(filename)?"image":/\.(mpe?g|flv|mov|avi|swf|mp4|mkv|webm|wmv|3gp)$/i.test(filename)?"video":/\.(mp3|ogg|wav|wma|amr|aac)$/i.test(filename)?"audio":"file");var fileIcons={file:"fa fa-file",image:"fa fa-picture-o file-image",video:"fa fa-film file-video",audio:"fa fa-music file-audio"},fileIcon=fileIcons[format];if(this.well_style){this.$label.append('<span class="ace-file-name" data-title="'+filename+'"><i class="'+ace.vars.icon+fileIcon+'"></i></span>');var type=inner_call===!0&&hasFile&&files[i]instanceof File?$.trim(files[i].type):"",can_preview=hasFileReader&&this.settings.thumbnail&&(type.length>0&&type.match("image")||0==type.length&&"image"==format);if(can_preview){var self=this;$.when(preview_image.call(this,files[i])).fail(function(result){self.settings.preview_error&&self.settings.preview_error.call(self,filename,result.code)})}}else this.$label.find(".ace-file-name").attr({"data-title":filename}).find(ace.vars[".icon"]).attr("class",ace.vars.icon+fileIcon)}return!0}},Ace_File_Input.prototype.reset_input=function(){this.reset_input_ui(),this.reset_input_field()},Ace_File_Input.prototype.reset_input_ui=function(){this.$label.attr({"data-title":this.settings.btn_choose,"class":"ace-file-container"}).find(".ace-file-name:first").attr({"data-title":this.settings.no_file,"class":"ace-file-name"}).find(ace.vars[".icon"]).attr("class",ace.vars.icon+this.settings.no_icon).prev("img").remove(),this.settings.no_icon||this.$label.find(ace.vars[".icon"]).remove(),this.$label.find(".ace-file-name").not(":first").remove(),this.reset_input_data()},Ace_File_Input.prototype.reset_input_field=function(){this.$element.wrap("<form>").parent().get(0).reset(),this.$element.unwrap()},Ace_File_Input.prototype.reset_input_data=function(){this.$element.data("ace_input_files")&&(this.$element.removeData("ace_input_files"),this.$element.removeData("ace_input_method"))},Ace_File_Input.prototype.enable_reset=function(can_reset){this.can_reset=can_reset},Ace_File_Input.prototype.disable=function(){this.disabled=!0,this.$element.attr("disabled","disabled").addClass("disabled")},Ace_File_Input.prototype.enable=function(){this.disabled=!1,this.$element.removeAttr("disabled").removeClass("disabled")},Ace_File_Input.prototype.files=function(){return $(this).data("ace_input_files")||null},Ace_File_Input.prototype.method=function(){return $(this).data("ace_input_method")||""},Ace_File_Input.prototype.update_settings=function(new_settings){this.settings=$.extend({},this.settings,new_settings),this.apply_settings()},Ace_File_Input.prototype.loading=function(is_loading){if(is_loading===!1)this.$container.find(".ace-file-overlay").remove(),this.element.removeAttribute("readonly");else{var inside="string"==typeof is_loading?is_loading:'<i class="overlay-content fa fa-spin fa-spinner orange2 fa-2x"></i>',loader=this.$container.find(".ace-file-overlay");0==loader.length&&(loader=$('<div class="ace-file-overlay"></div>').appendTo(this.$container),loader.on("click tap",function(e){return e.stopImmediatePropagation(),e.preventDefault(),!1}),this.element.setAttribute("readonly","true")),loader.empty().append(inside)}};var enable_drop_functionality=function(){var self=this,dropbox=this.$element.parent();dropbox.off("dragenter").on("dragenter",function(e){e.preventDefault(),e.stopPropagation()}).off("dragover").on("dragover",function(e){e.preventDefault(),e.stopPropagation()}).off("drop").on("drop",function(e){if(e.preventDefault(),e.stopPropagation(),!self.disabled){var dt=e.originalEvent.dataTransfer,file_list=dt.files;if(!self.multi&&file_list.length>1){var tmpfiles=[];tmpfiles.push(file_list[0]),file_list=tmpfiles}return file_list=processFiles.call(self,file_list,!0),file_list===!1?!1:(self.$element.data("ace_input_method","drop"),self.$element.data("ace_input_files",file_list),self.show_file_list(file_list,!0),self.$element.triggerHandler("change",[!0]),!0)}})},handle_on_change=function(){var file_list=this.element.files||[this.element.value];return file_list=processFiles.call(this,file_list,!1),file_list===!1?!1:(this.$element.data("ace_input_method","select"),this.$element.data("ace_input_files",file_list),this.show_file_list(file_list,!0),!0)},preview_image=function(file){var self=this,$span=self.$label.find(".ace-file-name:last"),deferred=new $.Deferred,getImage=function(src){$span.prepend("<img class='middle' style='display:none;' />");var img=$span.find("img:last").get(0);$(img).one("load",function(){imgLoaded.call(null,img)}).one("error",function(){imgFailed.call(null,img)}),img.src=src},imgLoaded=function(img){var size=50;"large"==self.settings.thumbnail?size=150:"fit"==self.settings.thumbnail&&(size=$span.width()),$span.addClass(size>50?"large":"");var thumb=get_thumbnail(img,size);if(null==thumb)return $(this).remove(),void deferred.reject({code:Ace_File_Input.error.THUMBNAIL_FAILED});var w=thumb.w,h=thumb.h;"small"==self.settings.thumbnail&&(w=h=size),$(img).css({"background-image":"url("+thumb.src+")",width:w,height:h}).data("thumb",thumb.src).attr({src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="}).show(),deferred.resolve()},imgFailed=function(){$span.find("img").remove(),deferred.reject({code:Ace_File_Input.error.IMAGE_LOAD_FAILED})};if(hasFile&&file instanceof File){var reader=new FileReader;reader.onload=function(e){getImage(e.target.result)},reader.onerror=function(){deferred.reject({code:Ace_File_Input.error.FILE_LOAD_FAILED})},reader.readAsDataURL(file)}else file instanceof Object&&file.hasOwnProperty("path")&&getImage(file.path);return deferred.promise()},get_thumbnail=function(img,size){var w=img.width,h=img.height;w=w>0?w:$(img).width(),h=h>0?h:$(img).height(),(w>size||h>size)&&(w>h?(h=parseInt(size/w*h),w=size):(w=parseInt(size/h*w),h=size));var dataURL;try{var canvas=document.createElement("canvas");canvas.width=w,canvas.height=h;var context=canvas.getContext("2d");context.drawImage(img,0,0,img.width,img.height,0,0,w,h),dataURL=canvas.toDataURL()}catch(e){dataURL=null}return dataURL?(/^data\:image\/(png|jpe?g|gif);base64,[0-9A-Za-z\+\/\=]+$/.test(dataURL)||(dataURL=null),dataURL?{src:dataURL,w:w,h:h}:null):null},processFiles=function(file_list,dropped){var ret=checkFileList.call(this,file_list,dropped);return-1===ret?(this.reset_input(),!1):ret&&0!=ret.length?((ret instanceof Array||hasFileList&&ret instanceof FileList)&&(file_list=ret),ret=!0,this.settings.before_change&&(ret=this.settings.before_change.call(this.element,file_list,dropped)),-1===ret?(this.reset_input(),!1):ret&&0!=ret.length?((ret instanceof Array||hasFileList&&ret instanceof FileList)&&(file_list=ret),file_list):(this.$element.data("ace_input_files")||this.reset_input(),!1)):(this.$element.data("ace_input_files")||this.reset_input(),!1)},getExtRegex=function(ext){return ext?("string"==typeof ext&&(ext=[ext]),0==ext.length?null:new RegExp(".(?:"+ext.join("|")+")$","i")):null},getMimeRegex=function(mime){return mime?("string"==typeof mime&&(mime=[mime]),0==mime.length?null:new RegExp("^(?:"+mime.join("|").replace(/\//g,"\\/")+")$","i")):null},checkFileList=function(files,dropped){var allowExt=getExtRegex(this.settings.allowExt),denyExt=getExtRegex(this.settings.denyExt),allowMime=getMimeRegex(this.settings.allowMime),denyMime=getMimeRegex(this.settings.denyMime),maxSize=this.settings.maxSize||!1;if(!(allowExt||denyExt||allowMime||denyMime||maxSize))return!0;for(var safe_files=[],error_list={},f=0;f<files.length;f++){var file=files[f],filename=hasFile?file.name:file;if(!allowExt||allowExt.test(filename))if(denyExt&&denyExt.test(filename))"ext"in error_list||(error_list.ext=[]),error_list.ext.push(filename);else{var type;if(hasFile){if((type=$.trim(file.type)).length>0){if(allowMime&&!allowMime.test(type)){"mime"in error_list||(error_list.mime=[]),error_list.mime.push(filename);continue}if(denyMime&&denyMime.test(type)){"mime"in error_list||(error_list.mime=[]),error_list.mime.push(filename);continue}}maxSize&&file.size>maxSize?("size"in error_list||(error_list.size=[]),error_list.size.push(filename)):safe_files.push(file)}else safe_files.push(file)}else"ext"in error_list||(error_list.ext=[]),error_list.ext.push(filename)}if(safe_files.length==files.length)return files;var error_count={ext:0,mime:0,size:0};"ext"in error_list&&(error_count.ext=error_list.ext.length),"mime"in error_list&&(error_count.mime=error_list.mime.length),"size"in error_list&&(error_count.size=error_list.size.length);var event;return this.$element.trigger(event=new $.Event("file.error.ace"),{file_count:files.length,invalid_count:files.length-safe_files.length,error_list:error_list,error_count:error_count,dropped:dropped}),event.isDefaultPrevented()?-1:safe_files};$.fn.aceFileInput=$.fn.ace_file_input=function(option,value){var retval,$set=this.each(function(){var $this=$(this),data=$this.data("ace_file_input"),options="object"==typeof option&&option;data||$this.data("ace_file_input",data=new Ace_File_Input(this,options)),"string"==typeof option&&(retval=data[option](value))});return retval===undefined?$set:retval},$.fn.aceFileInput.defaults=$.fn.ace_file_input.defaults={style:!1,no_file:"No File ...",no_icon:"fa fa-upload",btn_choose:"Choose",btn_change:"Change",icon_remove:"fa fa-times",droppable:!1,thumbnail:!1,allowExt:null,denyExt:null,allowMime:null,denyMime:null,maxSize:!1,before_change:null,before_remove:null,preview_error:null}}(window.jQuery);